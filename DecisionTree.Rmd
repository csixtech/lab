---
title: "Decision Trees"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Features considering to develop scoring	

FEATURES      | DESCRIPTION                                   | ANSWERS   
------------- | --------------------------------------------- | --------------------
STATUS        | Caracterization of the client                 | BOM ; MAU           
IDADE         | Age, in year                                  | [CAMPO NUM?RICO]
UNIFED        | State of residence                            | SP ; RJ ; OUTROS  
FONE          | Residential phone                             | SIM ; NAO  
RESTR         | Financial appointment ins TO?                 | SIM ; NAO
QUANTI        | Boughth more than 2 books in this trans.      | SIM ; NAO
NET           | Purchase was done on the internet?            | SIM ; NAO
	
Enabling Libraries <br>
```{r pacotes, message=FALSE, warning=FALSE}
library(caret) 
library(dplyr)
library(ggplot2)
library(grid)
library(gridExtra)
library(gmodels)
library(magrittr)
library(partykit)
library(rattle)
library(RColorBrewer) 
library(RODBC)
library(rpart) 
library(rpart.plot)
library(UsingR)
library(readxl)
```

Loading dataset BUXshrt.xlsx and visualizing structure:
```{r}
BUXshrt <- read_excel("E:/Google Drive/Fgv/Modelagem Preditiva - Abraham Laredo/R/BUXshrt.xlsx")
str(BUXshrt)
BUX=BUXshrt
```

Turn fields char into int to generate boxplots:
```{r, warning=FALSE}

# State (UF)
BUX$UNIFED_int[BUX$UNIFED=="SP"] <- "1"
BUX$UNIFED_int[BUX$UNIFED=="RJ"] <- "2"
BUX$UNIFED_int[BUX$UNIFED=="OUTROS"] <- "3"
BUX$UNIFED_int <- as.integer(BUX$UNIFED_int)

# Phone
BUX$FONE_int[BUX$FONE=="SIM"] <- "1"
BUX$FONE_int[BUX$FONE=="NAO"] <- "0"
BUX$FONE_int <- as.integer(BUX$FONE_int)

# Restriction
BUX$RESTR_int[BUX$RESTR=="SIM"] <- "1"
BUX$RESTR_int[BUX$RESTR=="NAO"] <- "0"
BUX$RESTR_int <- as.integer(BUX$RESTR_int)

# Quanti - more than 2 books bought
BUX$QUANTI_int[BUX$QUANTI=="SIM"] <- "1"
BUX$QUANTI_int[BUX$QUANTI=="NAO"] <- "0"
BUX$QUANTI_int <- as.integer(BUX$QUANTI_int)

# Net - purchase on the internet
BUX$NET_int[BUX$NET=="SIM"] <- "1"
BUX$NET_int[BUX$NET=="NAO"] <- "0"
BUX$NET_int <- as.integer(BUX$NET_int)

str(BUX)
```

<br>
Generating boxplots:
```{r}
bp1 <- boxplot(BUX$IDADE~BUX$STATUS,main="Status vs. Idade",ylab="Idade")
bp2 <- boxplot(BUX$UNIFED_int~BUX$STATUS,main="Status vs. Estado",ylab="Estado (1. SP, 2. RJ, 3. Outros)")
bp3 <- boxplot(BUX$FONE_int~BUX$STATUS,main="Status vs. Possui Telefone?",ylab="Possui Telefone? (0. N?o, 1. Sim)")
bp4 <- boxplot(BUX$RESTR_int~BUX$STATUS,main="Status vs. Apontamentos em TO", ylab="Apontamento TO? (0. N?o, 1. Sim)")
bp5 <- boxplot(BUX$QUANTI_int~BUX$STATUS,main="Status vs. + de 2 Livros", ylab="+ de 2 Livros? (0. N?o, 1. Sim)")
bp6 <- boxplot(BUX$NET_int~BUX$STATUS,main="Status vs. Compra na Internet",ylab="+ de 2 Livros? (0. N?o, 1. Sim)")
```

<br>
Seed; dividing between learing and test samples (with caret).
```{r}
#ID DS
set.seed(3174)

flag=createDataPartition(BUX$STATUS,p=.5,list=F) #randomly select elements for dataset BUX
lrn=BUX[flag,]  #learning dataframe
tst=BUX[-flag,] #test dataframe
# prop.table(table(lrn$STATUS))
# prop.table(table(tst$STATUS))
```

Creating initial tree ad1:
-- use dataset lrn to train tree and print it

```{r}
library(rpart)
ad1=rpart(data = lrn, STATUS~IDADE+UNIFED+FONE+RESTR+QUANTI+NET)
printcp(ad1)
```


Graphical representation of tree ad1:
```{r}
library(rpart.plot)
prp(ad1, type=2, extra=104, nn=T, fallen.leaves = T)
```


Prunning tree ad1 and printing tree ad2 (prunned tree):
```{r}
ad2=prune(ad1,cp=.015)

#bestcp <- ad1$cptable[which.min(ad1$cptable[,"xerror"]),"CP"]
#ad2 <- prune(ad1, cp = bestcp)

printcp(ad2)
prp(ad2, type=2, extra=104, nn=T, fallen.leaves = T,branch.lty = 3)

tst$prob=predict(ad2,newdata = tst,type = "prob")
print(head(tst$prob),digits = 3)
tst$ptur=tst$prob[,2]

PC=.8
klas=ifelse(tst$ptur>PC,"Ktur","kout")
m=table(tst$STATUS,klas)
m

fancyRpartPlot(ad2)

round(ad2$variable.importance, 3)
```

\pagebreak
Model Evaluation:
```{r}
clas2= predict(ad2, newdata = tst, type = "class") 
CrossTable(tst$STATUS, clas2, prop.chisq = F, prop.t = F) 
```


** Crosstable above shows an error rate of approx. 15.13% ((55+172)/1500). **
