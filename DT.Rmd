---
title: "Árvore de Decisões - Caso BUXshrt"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Variáveis para desenvolvimento do application scoring	

VARIÁVEL      | DESCRIÇÃO                                     | RESPOSTAS   
------------- | --------------------------------------------- | --------------------
STATUS        | Caracterização do cliente                     | BOM ; MAU           
IDADE         | Idade, em anos completos                      | [CAMPO NUMÉRICO]
UNIFED        | Unidade da Federação em que reside            | SP ; RJ ; OUTROS  
FONE          | Telefone residencial                          | SIM ; NAO  
RESTR         | Possuía desabonos financeiros em TO?          | SIM ; NAO
QUANTI        | Comprou mais de dois livros nessa operação?   | SIM ; NAO
NET           | A compra foi realizada pela Internet?         | SIM ; NAO
	
Habilitando Bibliotecas e Pacotes: <br>
```{r pacotes, message=FALSE, warning=FALSE}
library(caret) 
library(dplyr)
library(ggplot2)
library(grid)
library(gridExtra)
library(gmodels)
library(magrittr)
library(partykit)
library(rattle)
library(RColorBrewer) 
library(RODBC)
library(rpart) 
library(rpart.plot)
library(UsingR)
library(readxl)
```

Carregando o Dataset BUXshrt.xlsx e visualizando estrutura:
```{r}
BUXshrt <- read_excel("E:/Google Drive/Fgv/Modelagem Preditiva - Abraham Laredo/R/BUXshrt.xlsx")
str(BUXshrt)
BUX=BUXshrt
```

Transforma campos char em int para montagem dos boxplots:
```{r, warning=FALSE}
# TRANSFORMANDO ESTADO EM NUMERICO
BUX$UNIFED_int[BUX$UNIFED=="SP"] <- "1"
BUX$UNIFED_int[BUX$UNIFED=="RJ"] <- "2"
BUX$UNIFED_int[BUX$UNIFED=="OUTROS"] <- "3"
BUX$UNIFED_int <- as.integer(BUX$UNIFED_int)
# TRANSFORMANDO FONE EM NUMERICO
BUX$FONE_int[BUX$FONE=="SIM"] <- "1"
BUX$FONE_int[BUX$FONE=="NAO"] <- "0"
BUX$FONE_int <- as.integer(BUX$FONE_int)
# TRANSFORMANDO RESTR EM NUMERICO
BUX$RESTR_int[BUX$RESTR=="SIM"] <- "1"
BUX$RESTR_int[BUX$RESTR=="NAO"] <- "0"
BUX$RESTR_int <- as.integer(BUX$RESTR_int)
# TRANSFORMANDO QUANTI EM NUMERICO
BUX$QUANTI_int[BUX$QUANTI=="SIM"] <- "1"
BUX$QUANTI_int[BUX$QUANTI=="NAO"] <- "0"
BUX$QUANTI_int <- as.integer(BUX$QUANTI_int)
# TRANSFORMANDO NET EM NUMERICO
BUX$NET_int[BUX$NET=="SIM"] <- "1"
BUX$NET_int[BUX$NET=="NAO"] <- "0"
BUX$NET_int <- as.integer(BUX$NET_int)

str(BUX)
```

<br>
Gerando gráficos bloxplot para entendimento das relações:
```{r}
bp1 <- boxplot(BUX$IDADE~BUX$STATUS,main="Status vs. Idade",ylab="Idade")
bp2 <- boxplot(BUX$UNIFED_int~BUX$STATUS,main="Status vs. Estado",ylab="Estado (1. SP, 2. RJ, 3. Outros)")
bp3 <- boxplot(BUX$FONE_int~BUX$STATUS,main="Status vs. Possui Telefone?",ylab="Possui Telefone? (0. Não, 1. Sim)")
bp4 <- boxplot(BUX$RESTR_int~BUX$STATUS,main="Status vs. Apontamentos em TO", ylab="Apontamento TO? (0. Não, 1. Sim)")
bp5 <- boxplot(BUX$QUANTI_int~BUX$STATUS,main="Status vs. + de 2 Livros", ylab="+ de 2 Livros? (0. Não, 1. Sim)")
bp6 <- boxplot(BUX$NET_int~BUX$STATUS,main="Status vs. Compra na Internet",ylab="+ de 2 Livros? (0. Não, 1. Sim)")
```

Carregando seed; dividindo em series de treino e de teste.
```{r}
#ID DS
set.seed(3174)

flag=createDataPartition(BUX$STATUS,p=.5,list=F) #seleciona aleatoriamente parte dos registros do dataseet BUX
lrn=BUX[flag,]  #dataframe de treino
tst=BUX[-flag,] #datafrmae de teste
# prop.table(table(lrn$STATUS))
# prop.table(table(tst$STATUS))
```

Criação da primeira árvore ad1:
-- usa o dataset lrn para treinar a arvore e imprimi tabela

```{r}
library(rpart)
ad1=rpart(data = lrn, STATUS~IDADE+UNIFED+FONE+RESTR+QUANTI+NET)
printcp(ad1)
```

Representação gráfica da árvore ad1:

```{r}
library(rpart.plot)
prp(ad1, type=2, extra=104, nn=T, fallen.leaves = T)
```

Poda da árvore ad1 e representação gráfica da árvore ad2 (árvore já podada):

```{r}
ad2=prune(ad1,cp=.015)

#bestcp <- ad1$cptable[which.min(ad1$cptable[,"xerror"]),"CP"]
#ad2 <- prune(ad1, cp = bestcp)

printcp(ad2)
prp(ad2, type=2, extra=104, nn=T, fallen.leaves = T,branch.lty = 3)

tst$prob=predict(ad2,newdata = tst,type = "prob")
print(head(tst$prob),digits = 3)
tst$ptur=tst$prob[,2]

PC=.8
klas=ifelse(tst$ptur>PC,"Ktur","kout")
m=table(tst$STATUS,klas)
m

fancyRpartPlot(ad2)

round(ad2$variable.importance, 3)
```

\pagebreak
Avaliação do modelo:
```{r}
clas2= predict(ad2, newdata = tst, type = "class") 
CrossTable(tst$STATUS, clas2, prop.chisq = F, prop.t = F) 
```

** Na tabela cruzada (Crosstable) acima, podemos verificar que a taxa de erro é de aprox. 15.4% ((66+165)/1500).**  
